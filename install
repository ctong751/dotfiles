#!/bin/bash
set -e

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKUP_DIR="$HOME/.dotfiles-backup/$(date +%Y%m%d-%H%M%S)"
backed_up=false

# Colors & symbols
if [[ -t 1 ]]; then
    bold='\033[1m'
    dim='\033[2m'
    green='\033[32m'
    yellow='\033[33m'
    red='\033[31m'
    reset='\033[0m'
else
    bold='' dim='' green='' yellow='' red='' reset=''
fi

# Buffered output — collects items per section, prints one line when flushed
_section="" _items=""
section() {
    flush
    _section="$1"
    _items=""
}
ok()   { [[ -n "$_items" ]] && _items+=", "; _items+="$1"; }
warn() { printf "  ${yellow}⚠ %-10s${reset} %s\n" "$_section" "$1"; }
err()  { printf "  ${red}✗ %-10s${reset} %s\n" "$_section" "$1"; }
info() { printf "  ${dim}  %-10s %s${reset}\n" "" "$1"; }
flush() {
    [[ -z "$_section" ]] && return
    printf "  ${green}✓${reset} ${bold}%-10s${reset} ${dim}%s${reset}\n" "$_section" "$_items"
}

pkg_install() {
    local pkg="$1"
    if command -v brew &>/dev/null; then
        brew install "$pkg"
    elif command -v apt &>/dev/null; then
        sudo apt install -y "$pkg"
    else
        err "no package manager found (need brew or apt)"
        return 1
    fi
}

ensure() {
    local cmd="$1"
    local pkg="${2:-$1}"
    if ! command -v "$cmd" &>/dev/null; then
        pkg_install "$pkg"
    fi
}

backup() {
    local target="$1"
    if [[ -e "$target" && ! -L "$target" ]]; then
        if [[ "$backed_up" == false ]]; then
            mkdir -p "$BACKUP_DIR"
            backed_up=true
        fi
        cp -r "$target" "$BACKUP_DIR/"
    fi
}

link() {
    local src="$1"
    local dst="$2"
    backup "$dst"
    rm -rf "$dst"
    ln -s "$src" "$dst"
    ok "$(basename "$dst")"
}

printf "\n${bold}  dotfiles${reset} ${dim}— installing into %s${reset}\n\n" "$HOME"

# Neovim
section "nvim"
ensure nvim neovim
mkdir -p "$HOME/.config"
link "$BASEDIR/nvim" "$HOME/.config/nvim"

# Git
section "git"
link "$BASEDIR/git/gitconfig" "$HOME/.gitconfig"
link "$BASEDIR/git/gitignore" "$HOME/.gitignore"

# Ghostty
section "ghostty"
mkdir -p "$HOME/.config/ghostty"
link "$BASEDIR/ghostty/config" "$HOME/.config/ghostty/config"

# Zsh
section "zsh"
link "$BASEDIR/zsh/zshrc" "$HOME/.zshrc"
link "$BASEDIR/zsh/p10k.zsh" "$HOME/.p10k.zsh"

# Tmux
section "tmux"
ensure tmux
link "$BASEDIR/tmux" "$HOME/.config/tmux"

# Claude Code
section "claude"
mkdir -p "$HOME/.claude"
if [[ -f "$HOME/.claude/settings.json" ]]; then
    if command -v python3 &>/dev/null; then
        python3 -c "
import json, sys
with open('$HOME/.claude/settings.json') as f:
    existing = json.load(f)
with open('$BASEDIR/claude/settings.json') as f:
    dotfiles = json.load(f)
existing.update(dotfiles)
with open('$HOME/.claude/settings.json', 'w') as f:
    json.dump(existing, f, indent=2)
    f.write('\n')
"
        ok "settings.json (merged)"
    else
        warn "python3 not found, skipping settings merge"
    fi
else
    link "$BASEDIR/claude/settings.json" "$HOME/.claude/settings.json"
fi
link "$BASEDIR/claude/CLAUDE.md" "$HOME/.claude/CLAUDE.md"

# Hotkeys (Linux + GNOME only)
if [[ "$(uname)" == "Linux" ]] && command -v gsettings &>/dev/null; then
    section "hotkeys"
    ensure wmctrl
    ensure xdotool
    mkdir -p "$HOME/.config/hotkeys"
    link "$BASEDIR/hotkeys/focus-or-open" "$HOME/.config/hotkeys/focus-or-open"
    "$BASEDIR/hotkeys/setup-gnome-keybindings.sh"
fi

# Keyboard (Linux only — remap Caps Lock to Control)
if [[ "$(uname)" == "Linux" && -f /etc/default/keyboard ]]; then
    section "keyboard"
    if ! grep -q 'ctrl:nocaps' /etc/default/keyboard; then
        sudo cp "$BASEDIR/keyboard/keyboard" /etc/default/keyboard
        ok "caps lock → control"
        info "reboot or run 'sudo dpkg-reconfigure keyboard-configuration' to apply"
    else
        ok "ctrl:nocaps"
    fi
fi

flush
printf "\n${bold}${green}  ✓ done${reset}"
if [[ "$backed_up" == true ]]; then
    printf " ${dim}(backups in $BACKUP_DIR)${reset}"
fi
printf "\n\n"
