#!/bin/bash
set -e

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKUP_DIR="$HOME/.dotfiles-backup/$(date +%Y%m%d-%H%M%S)"
backed_up=false

pkg_install() {
    local pkg="$1"
    if command -v brew &>/dev/null; then
        brew install "$pkg"
    elif command -v apt &>/dev/null; then
        sudo apt install -y "$pkg"
    else
        echo "  ERROR: No supported package manager found (need brew or apt)"
        echo "  Please install $pkg manually and re-run this script"
        return 1
    fi
}

ensure() {
    local cmd="$1"
    local pkg="${2:-$1}"
    if ! command -v "$cmd" &>/dev/null; then
        echo "  $cmd not found, installing..."
        pkg_install "$pkg"
    fi
}

backup() {
    local target="$1"
    if [[ -e "$target" && ! -L "$target" ]]; then
        if [[ "$backed_up" == false ]]; then
            mkdir -p "$BACKUP_DIR"
            backed_up=true
        fi
        cp -r "$target" "$BACKUP_DIR/"
        echo "  Backed up $(basename "$target") -> $BACKUP_DIR/"
    fi
}

link() {
    local src="$1"
    local dst="$2"
    backup "$dst"
    rm -rf "$dst"
    ln -s "$src" "$dst"
    echo "  Linked $dst -> $src"
}

echo "Installing dotfiles..."
echo ""

# Neovim
echo "[nvim]"
ensure nvim neovim
mkdir -p "$HOME/.config"
link "$BASEDIR/nvim" "$HOME/.config/nvim"

# Zsh
echo "[zsh]"
link "$BASEDIR/zsh/zshrc" "$HOME/.zshrc"
link "$BASEDIR/zsh/p10k.zsh" "$HOME/.p10k.zsh"

# Tmux
echo "[tmux]"
ensure tmux
link "$BASEDIR/tmux" "$HOME/.config/tmux"

# Claude Code
echo "[claude]"
mkdir -p "$HOME/.claude"
if [[ -f "$HOME/.claude/settings.json" ]]; then
    # Merge statusLine into existing settings rather than overwriting
    if command -v python3 &>/dev/null; then
        python3 -c "
import json, sys
with open('$HOME/.claude/settings.json') as f:
    existing = json.load(f)
with open('$BASEDIR/claude/settings.json') as f:
    dotfiles = json.load(f)
existing.update(dotfiles)
with open('$HOME/.claude/settings.json', 'w') as f:
    json.dump(existing, f, indent=2)
    f.write('\n')
"
        echo "  Merged statusLine config into ~/.claude/settings.json"
    else
        echo "  WARNING: python3 not found, skipping Claude settings merge"
        echo "  Manually add statusLine config from $BASEDIR/claude/settings.json"
    fi
else
    link "$BASEDIR/claude/settings.json" "$HOME/.claude/settings.json"
fi

echo ""
echo "Done!"
if [[ "$backed_up" == true ]]; then
    echo "Backups saved to: $BACKUP_DIR"
fi
